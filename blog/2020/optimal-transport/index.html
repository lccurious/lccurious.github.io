<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> 最优传输理论 | Curiousity Hub </title> <meta name="author" content="Zenan Huang"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="causal-learning, causal-discovery, transfer-learning, LLMs, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon-32x32-next-my.png?b29ea1d332f6bc3c021e15d78d266303"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://lccurious.github.io/blog/2020/optimal-transport/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Curiousity Hub </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/cv/">cv</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">最优传输理论</h1> <p class="post-meta"> January 30, 2020 </p> <p class="post-tags"> <a href="/blog/2020"> <i class="fa-solid fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/%E6%9C%80%E4%BC%98%E4%BC%A0%E8%BE%93"> <i class="fa-solid fa-hashtag fa-sm"></i> 最优传输</a>   <a href="/blog/tag/optimal-transport"> <i class="fa-solid fa-hashtag fa-sm"></i> optimal transport</a>     ·   <a href="/blog/category/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0"> <i class="fa-solid fa-tag fa-sm"></i> 机器学习</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>最优传输问题的描述，如果用两个沙堆的问题表示：一个沙堆如何通过最小的代价推成和另一个沙堆一样的形状。或者另外一个电商的问题：电商有 \(N\) 个储存区域，同时 \(M\) 个订购电子书阅读器的客户。假设第 \(n\) 个存储区域 \(x_n\) 有 \(m_n\) 个阅读器，第 \(k\) 个客户 \(y_k\) 订购 \(h_k\) 个阅读器。传输代价 \(c(x,y)\) 是存储区域 \(y\) 与客户 \(x\) 之间的距离。最优传输问题就是要找到最合适的方式，将存储区域中的所有阅读器运送到订购它们的客户那里。传输地图 \(\Pi\) 可以视为一个矩阵，矩阵的条目或元素 \(\Pi_{nk}\) 表示从第 \(n\) 个存储区域发送到第 \(k\) 个客户的电子阅读器数量。为了保持一致，离开第 \(n\) 个存储区域的所有阅读器总数必须等于在该区域中存储的阅读器总数，同时所有顾客收到的阅读器总和必须等于顾客订购的电子书阅读器的数量<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>。</p> <h2 id="问题形式化">问题形式化</h2> <p>传输地图的形式有一个确定的约束，也就是两个分布中的元素数量都是固定的传输的东西不会超过某个分布本身有的数量之和。 \begin{equation} \begin{array}{c}{\sum_{k} \Pi_{n k}=m_{n}} \\ {\sum_{n} \Pi_{n k}=h_{k}}\end{array} \end{equation} 另外，要服从一个约束，所有矩阵的元素必须为正的，约束下的最优解则为： \begin{equation} \hat{\gamma}=\operatorname{argmin}_{\Pi} \sum \Pi_{n k} c\left(x_{n}, y_{k}\right) \end{equation} 其中 \(\gamma\) 表示要把一个分布 \(P(X)\) 变换成另一个分布 \(Q(Y)\) 的传输方案，是传输地图 \(\Pi\) 中的一个子集，这个子集能够使二者之间的传输的代价最小化。虽然在现实中，一次可以运多个，运输成本和运输量不会是线性关系，但是出于分析方便下面使用这种简化的表述形式。</p> <p>其中为了方面分析的过程，约定下面的符号：</p> <ul> <li>度量空间 \(\mathcal{X}\) 和 \(\mathcal{Y}\) （完全的，可分的）</li> <li>代价函数 \(c:\mathcal{X}\times \mathcal{Y}\rightarrow \mathbb{R}\cup \{\infty \}\) （下界，lsc）</li> <li>概率测度 \(\mu\in \mathcal{P}(\mathcal{X})\) 和 \(\upsilon\in \mathcal{P}(\mathcal{Y})\) 或者可以写成 \(\mu=\frac{1}{N}\sum^{N}_{i=1}\delta_{x^{i}},\nu=\frac{1}{M}\sum^{M}_{i=1}\delta_{y^{i}}\) (离散的情况下可以立即成一种计数统计手段，只有两个完全一样的数据会被加两次，离散情况下很可能分布统计中的每个bin都一样高且为\(\frac{1}{N}\)或\(\frac{1}{M}\))</li> </ul> <h3 id="原始形式">原始形式</h3> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/image-20210210161415614-480.webp 480w,/assets/img/2020-01-30-optimal-transport/image-20210210161415614-800.webp 800w,/assets/img/2020-01-30-optimal-transport/image-20210210161415614-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/image-20210210161415614.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="image-20210210161415614" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">image-20210210161415614</figcaption> </figure> </div> </div> <ul> <li>如何用做最小的功把一堆沙子从一批坑里到另一批坑里</li> <li>找到各个坑之间的对应关系\(T\)（传输）</li> <li>从x搬到y做功\(c(x,y)\)，目标是让它最小化</li> </ul> <h3 id="monge形式">Monge形式</h3> <p>给定两个概率分布\(\mu_s,\mu_t\)和代价函数\(c:\Omega_{s}\times \Omega_{t}\rightarrow\mathbb{R}^{+}\)，Monge形式就是要找到一个代价最小的传输方案\(T\)： \begin{equation} T^{*}=\inf_{T\#\mu_{s}=\mu_{t}}\int_{\Omega_{s}}c(\mathbf{x},T(\mathbf{x}))\mu_{s}(\mathbf{x})d\mathbf{x} \end{equation} 通过把传输方案\(T\)应用到(\(\#\))某个源分布\(\mu_{s}\)上就可以把它变换成目标分布\(\mu_{t}\)。使代价综合最小的方案就是我们要的最优传输方案。</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/image-20210210162343753-480.webp 480w,/assets/img/2020-01-30-optimal-transport/image-20210210162343753-800.webp 800w,/assets/img/2020-01-30-optimal-transport/image-20210210162343753-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/image-20210210162343753.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="image-20210210162343753" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">image-20210210162343753</figcaption> </figure> </div> </div> <p>如上图所示随便取一个源分布中的子集（粗糙的说是某块区域，严格的说是任意Borel集），就可以通过传输方案映射（\(T\#\)）到目标域中去。</p> <p>但是因为有这个\(T\#\mu_{s}=\mu_{t}\)限制条件的存在，这就变成了一个难以求解的非凸问题。总结成下面几点使我们不得再寻找更好的形式化：</p> <ul> <li>\(T\#\mu_{s}=\mu_{t}\) 是非凸的约束</li> <li>最优传输方案\(T\)并不一定存在</li> <li>最优传输方案\(T\)并不一定是唯一的 <ul> <li>[Brenier, 1991]证明了当\(c(x,y)=\| x-y\| ^{2}\)时最优传输方案存在且唯一</li> </ul> </li> </ul> <h3 id="kantorovich-形式">Kantorovich 形式</h3> <p>为了和蒙日形式的最优传输方案做符号区分，这里的传输方案用\(\gamma\)来表示。</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/image-20210212142637523-480.webp 480w,/assets/img/2020-01-30-optimal-transport/image-20210212142637523-800.webp 800w,/assets/img/2020-01-30-optimal-transport/image-20210212142637523-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/image-20210212142637523.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="image-20210212142637523" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">image-20210212142637523</figcaption> </figure> </div> </div> <p>Kantorovich提出不一定要按照整数的方式去传输，可以把大石子打碎了传输，所以提出用两个集合耦合的概率分布来表示传输方案：</p> \[\begin{split} \gamma_{0}=&amp;\text{argmin}_{\gamma}\int_{\Omega_{s}\times\Omega{t}}c(\mathbf{x},\mathbf{y})\gamma(\mathbf{x},\mathbf{y})d\mathbf{x}d\mathbf{y},\\\\ \text{s.t.}&amp;\quad \gamma\in\mathcal{P}\{\gamma\geq0, \int_{\Omega_{t}}\gamma(\mathbf{x},\mathbf{y})d\mathbf{y}=\mu_{s},\int_{\Omega_{s}}\gamma(\mathbf{x},\mathbf{y})d\mathbf{x}=\mu_{t}\}\end{split}\] <ul> <li>\(\gamma\)是\(\mu_{s},\mu_{t}\)的联合分布</li> <li>线形规划总是会有一个解</li> </ul> <p>在对最优传输的求解和相关理论证明推广的过程中，对偶理论是一项非常重要的基础理论。</p> <p><strong>Kantorovich 对偶：</strong>Let \(\mu\in\mathcal{P}(X),\nu\in\mathcal{P}(Y)\) where \(X,Y\) are Polish spaces. Let \(c:X\times Y\rightarrow [0, +\infty]\) be a lower semi-continuous cost function. Define \(\mathbb{K}\) as (given \(\mu\in\mathcal{P}(X)\) and \(\nu\in\mathcal{P}(Y)\) then \(\mathbb{K}(\pi)=\int_{X\times Y}c(x,y)d\pi(x,y)\)) and \(\mathbb{J}\) by: \begin{equation} \mathbb{J}:L^{1}(\mu)\times L^{1}(\nu)\rightarrow \mathbb{R}, \quad \mathbb{J}(\varphi, \psi)=\int_{X}\varphi d\mu+\int_{Y}\psi d\nu. \end{equation} Let \(\Phi_{c}\) be defined by: \begin{equation} \Phi_{c}={(\varphi, \psi)\in L^{1}(\mu)\times L^{1}(\nu): \varphi(x)+\psi(y)\leq c(x,y)}, \end{equation} where the inequality is understood to hold for \(\mu-almost\) every \(x\in X\) and \(\nu-almost\) every \(y\in Y\). Then: \begin{equation} \min_{\pi\in \prod(\mu, \nu)}\mathbb{K}(\pi)=\sup_{(\varphi,\psi)\in\Phi_{c}}\mathbb{J}(\varphi, \psi). \end{equation} 我们通过运货商问题直观地证明上面的这个结论，假设我们现在有一批煤矿和一些工厂，每个煤矿的产量和每个工厂的需求量都是固定的。从煤矿\(x\)运输到工厂\(y\)的成本是\(c(x,y)\)，使成本总和最小的运输方案就是Kantorovich的最优传输方案。后来，有一个聪明的运输员来找你，说你只要付\(\varphi(x)\)用于装车，\(\psi(y)\)用于卸货。为了使你更加感兴趣，他还提出他保证装车成本\(\varphi\)和卸货成本\(\psi\)一定不会超过原来的运输方案\(c(x,y)\)，即\(\varphi(x)+\psi(y)\leq c(x,y)\)。<strong>也就是Kantorovich对偶告诉我们可以找到\(\varphi\)和\(\psi\)使得价格组成方案最多都不会超过原形式的运输方案</strong>。</p> <p>借助这个直观的解释（一部分给自己运，一部分交给运货商的话）给出非正式的证明过程，令\(M=\inf_{\pi\in\prod(\mu,\nu)}\mathbb{K{(\pi)} }\)，可以观察到：</p> <p>\begin{equation} M=\inf_{\pi\in \mathcal{M}_{+}(X\times Y)}\sup_{(\varphi, \psi)}\left(\int_{X\times Y}c(x,y)d\pi+\int_{X}\varphi d(\mu-P^{X}_{\#}\pi)+\int_{Y}\psi d(\nu-P^{Y}_{\#}\pi)\right)\label{eq:M} \end{equation}</p> <p>我们在\((\varphi,\psi)\in C^{0}_{b}(X)\times C^{0}_{b}(Y)\)取方程右边的上界，如下：</p> <p>\begin{equation} \sup_{\varphi\in C^{0}_{b}(X)}\int_{X}\varphi d(\mu-P^{X}_{\#}\pi)=\left\{\begin{array}{ll}+\infty &amp; {\rm if}~\mu\neq P^{X}_{\#}\pi\\0 &amp; {\rm else.} \end{array}\right. \end{equation}</p> <p>因此，在\(\pi\)上的下界就在\(P^{X}_{\# }\pi=\mu\)的时候取到，同理，\(P^{Y}_{ \# }\pi=\nu\)，重写公式(\(\ref{eq:M}\))有 \begin{equation} M=\inf_{\pi\in\mathcal{M}_{+}(X\times Y)}\sup_{(\varphi,\psi)}\left(\int_{X\times Y}c(x,y)-\varphi(x)-\psi(y)d\pi+\int_{X}\varphi d\mu + \int_{Y}\psi d\nu\right). \end{equation} 根据自变量的影响范围整理上面公式得到： \begin{equation} M=\sup_{(\varphi,\psi)}\left(\int_{X}\varphi d\mu+\int_{Y}\psi d\nu+\inf_{\pi\in\mathcal{M}_{+}(X\times Y)}\int_{X\times Y}c(x,y)-\varphi(x)-\psi(y)d\pi\right). \end{equation} 假如存在\((x_{0},y_{0})\in X\times Y\)和\(\epsilon&gt;0\)使得\(\varphi(x_{0})+\psi(y_{0})-c(x_{0},y_{0})=\epsilon&gt;0\)，然后通过令\(\pi_{\lambda}=\lambda\delta_{(x_{0}, y_{0})}\)，对于任意的\(\lambda&gt;0\)我们有： \begin{equation} \inf_{\pi\in\mathcal{M}_{+}(X\times Y)}\int_{X\times Y}c(x,y)-\varphi(x)-\psi(y)d\pi\leq -\lambda\epsilon \rightarrow -\infty\quad{\rm as}\quad\lambda\rightarrow\infty. \end{equation}</p> <p>因此，\(M\)的下界可以限制为当\(\varphi(x)+\psi(y)\leq c(x,y)\)时，所有\((x,y)\in X\times Y\)，也就是\((\varphi,\psi)\in \Phi_{c}\)（这种启发式的争论其实是用\((\varphi,\psi)\in C^{0}_b(X)\times C^{0}_{b}(Y)\)而不是\(L^{1}(\mu)\times L^{1}(\nu)\)这和限制\(\varphi(x)+\psi(y)\leq c(x,y)\)处处存在有些不同，是几乎处处存在的，不过这些更深入的细节这里暂时不做讨论），当\((\varphi,\psi)\in\Phi_{c}\)有： \begin{equation} \inf_{\pi\in\mathcal{M}_{+}(X\times Y)}\int_{X\times Y}c(x,y)-\varphi(x)-\psi(y)d\pi=0 \end{equation} 在\(\pi \equiv 0\)成立（例如），因此： \begin{equation} \inf_{\pi\in\prod(\mu, \nu)}\mathbb{K}(\pi)=\sup_{(\varphi,\psi)\in \Phi_{c}}\int_{X}\varphi(x)d\mu(x)+\int_{Y}\psi(y)d\nu(y) \end{equation} 这就是Kantorovich对偶的形式了，关于它的详细证明还需要很多篇幅。可以参考<em>Introduction to Optimal Transport</em>。</p> <h3 id="sinkhorn-距离">Sinkhorn 距离</h3> <p>随着最优传输所使用的维度升高，最优传输的求解复杂度很快就会变得不可接受。所以Marco Cuturi,2013<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">2</a></sup>等提出从熵最大化的角度来看待传输问题。在原始的最优传输形式中加入传输方案熵正则化项来平滑经典的最优传输问题，这种新形式下的优化就可以通过Sinkhorn’s matrix scaling算法来解决。这种修改后的计算方式可以大大加快原始的最优传输优化形式的求解。</p> <p>对于任意两个概率向量\(\mu,\nu\in\Sigma_{d}:=\{x\in \mathbb{R}^{d}_{+}:x^{T}\mathbf{1}_{d}=1\}\)，用\(U(\mu,\nu)\)表示\(\mu\)和\(\nu\)的传输可行空间： \begin{equation} U(\mu,\nu):={P\in\mathbb{R}^{d\times d}_{+}|P\mathbf{1}_{d}=\nu,P^{T}\mathbf{1}_{d}=\mu} \end{equation} 其中任意矩阵\(P\in U(\mu,\nu)\)其中\(p(X=i,Y=j)=p_{ij}\)，然后定义熵\(h(P)\)： \begin{equation} h(P)=-\sum^{d}_{i,j=1}p_{ij}\log p_{ij} \end{equation} 给定一个\(d\times d\)的代价矩阵\(M\)，那么从\(\mu\)传输到\(\nu\)的传输代价就可以写成： \begin{equation} d_{M}(\mu,\nu):=\min_{P\in U(\mu,\nu)}\langle P, M\rangle. \end{equation} 当矩阵\(M\)本身是一个度量矩阵时，即当\(M\)属于距离矩阵的锥时： \begin{equation} \mathcal{M}={M\in\mathbb{R}^{d\times d}_{+}:\forall i,j\leq d,m_{ij}=0\Leftrightarrow i=j,\forall i,j,k\leq d,m_{ij}\leq m_{ik}+m_{kj}} \end{equation} <strong>联合分布中的熵限制</strong>(<em>Cover and Thomas,1991,section 2</em>): \begin{equation} \forall \mu,\nu\in\Sigma_{d},\forall P\in U(\mu,\nu),h(P)\leq h(\mu)+h(\nu), \end{equation} 当\(\mu\)和\(\nu\)相互独立的时候有\(h(\mu\nu^{T})=h(\mu)+h(\nu)\)，利用这个熵的凸性质，可以有： \begin{equation} U_{\alpha}(\mu,\nu):={P\in U(\mu, \nu)|KL(P||\mu\nu^{T})\leq \alpha}={P\in U(\mu, \nu)|h(P)\geq h(\mu)+h(\nu)-\alpha} \end{equation} 因此，就可以把对\(\mu\nu^{T}\)的KL散度小于某个阈值的\(P\)的集合解释为一系列在\(U(\mu,\nu)\)中的联合分布\(P\)，它对\(h(\mu)\)和\(h(\nu)\)有足够的熵，或者足够小的互信息。</p> <p>所以定义Sinkhorn Distance为： \begin{equation} d_{M,\alpha}(\mu,\nu):=\min_{P\in U_{\alpha}(\mu,\nu)}\langle P, M\rangle. \end{equation}</p> <blockquote> <p>之所以考虑在最优传输中使用熵的限制是因为，经典的线性规划的结果都是在可行域的顶点上取到。这样的一个\(d\times d\)维度的顶点通常最多只有\(2d-1\)个非零的元素。从概率的角度看这个顶点则是一个准确定性联合分布，因为一旦某一行有个元素\(p_{ij}&gt;0\)，这一行的其他元素\(p_{ij'}\)其中\(j'\neq j\)就很少是非零的了。</p> </blockquote> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/image-20210307110425631-480.webp 480w,/assets/img/2020-01-30-optimal-transport/image-20210307110425631-800.webp 800w,/assets/img/2020-01-30-optimal-transport/image-20210307110425631-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/image-20210307110425631.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="image-20210307110425631" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">image-20210307110425631</figcaption> </figure> </div> </div> <p>另外再证明了三角不等式： \begin{equation} d_{M,\alpha}(x,z)=\min_{P\in U_{\alpha}(x,z)}\langle P,M\rangle \leq\langle S, M\rangle\leq d_{M,\alpha}(x,y)+d_{M,\alpha}(y,z) \end{equation} 可以大致确认通过一些优化手段是可以找到最优解的，然后考虑有熵限制条件的优化问题： \begin{equation} {\rm For}~\lambda&gt;0,d^{\lambda}_{M}(\mu,\nu):=\langle P^{\lambda},M\rangle,~{\rm where}~P^{\lambda}={\rm argmin}_{P\in U(\mu, \nu)}\langle P,M\rangle-\frac{1}{\lambda}h(P). \end{equation} 基于对偶理论有任意的\(\alpha\)对应于一个\(\lambda\in[0, +\infty]\)使得\(d_{M,\alpha}(\mu,\nu)=d^{\lambda}_{M}(\mu, \nu)\)，这个\(d^{\lambda}_{M}\)就叫做dual-Sinkhorn divergence，它可以被很方便地计算得到。</p> <p>从上图也可以看到传输方案\(P^{\lambda}\)的熵随着\(\lambda\)的增大而单调递增，我们可以通过不断增大\(\lambda\)直到\(h(P^{\lambda})\)到达\(h(\mu)+h(\nu)-\alpha\)。</p> <p><strong>通过Matrix Scaling Algorithm来对\(d^{\lambda}_{M}\)进行求解</strong>，对于任意\(\lambda&gt;0\)有唯一解\(P^{\lambda}={\rm diag}(\mu)K{\rm diag}(\nu)\)，其中\(K:=e^{-\lambda M}\)。</p> <p>利用拉格朗日乘子法和对偶变量\(\alpha,\beta\in\mathbb{R}^{d}\)代入\(U(\mu,\nu)\)中的限制条件： \begin{equation} \mathcal{L}(P,\alpha,\beta)=\sum_{ij}\frac{1}{\lambda}p_{ij}\log p_{ij}+p_{ij}m_{ij}+\alpha^{T}(P\mathbf{1}_{d}-\mu)+\beta^{T}(P\mathbf{1}_{d}-\nu). \end{equation} 取\(\frac{\partial \mathcal{L}}{\partial p_{ij}}=0\)可以推出\(p_{ij}=e^{-1/2-\lambda\alpha_{i}}e^{-\lambda m_{ij}}e^{-1/2-\lambda\beta_{i}}\)，\(P^{\lambda}\)因此就必定是对应的矩阵，可以通过Sinkhorn’s固定点迭代\((r,c)\leftarrow(\mu./Kr,\nu./K'c)\)得到。</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/image-20210307110537149-480.webp 480w,/assets/img/2020-01-30-optimal-transport/image-20210307110537149-800.webp 800w,/assets/img/2020-01-30-optimal-transport/image-20210307110537149-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/image-20210307110537149.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="image-20210307110537149" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">image-20210307110537149</figcaption> </figure> </div> </div> <h2 id="补充资料">补充资料</h2> <h3 id="符号说明">符号说明</h3> <ul> <li>\(C^{0}_{b}(Z)\) 是定义在\(Z\)上的全体连续有界函数</li> <li>\(\mathcal{M}_{+}(Z)\) 是\(Z\)上正的拉东测度的集合</li> <li>\(\mathcal{P}(Z)\)是在\(Z\)上的概率测度的集合，也就是\(\mathcal{M}_{+}(Z)\)有单位质量的子集</li> </ul> <h3 id="测度">测度</h3> <p>测度用于表示我们对于大小的直观概念，比如长度、面积、体积和质量等，有了这种度量我们才能将严格地讨论它们，并且将它们扩展一些直观上无法理解其大小的领域，比如函数空间。</p> <p>一个测度就是一个函数，例如 \(\mu\) 从一个 \(\sigma\)-代数到一个非负的实数值，0 就表示一个空集，而当一个集合由很多<strong>互斥的子集</strong> \(\{X_{i}\}\) 组成时，我们则有： \begin{equation} \mu(\cup X_{i})=\sum\mu(X_{i}) \end{equation} 直观的理解就是，如果两个集合它们之间没有任何交集，则把它们合在一起获得的新的并集大小就是它们各自的大小之和。</p> <h3 id="概率测度">概率测度</h3> <p>如果全集的测度值被定义为 1，那这个测度就可以称为一个概率测度。在理论测量概率中，我们定义一个 \(\sigma\)-代数集，是一个包括了所有可能性的集合。我们拿出其中的一个子集来举例，扔出去的一个骰子可能是 1 也可能不是 1（某个子集），可能是偶数也可能是其他（另一个子集）。子集的度量称为定义它的事件的概率。</p> <ul> <li> <strong>概率空间</strong>：一个概率空间是一个 \(X\) 集合的三倍，一个超过它的 \(\sigma\)-代数，\(\mathcal{X}\)，和一个概率测度 \(\mu\)</li> <li> <strong>可测空间</strong>：一个可测空间是一组集合 \(X\) 连同其子集的 \(\sigma\)-代数的对</li> <li> <strong>测度空间</strong>：一个测度空间是一个 \(X\) 集合的三倍，一个其子集的 \(\sigma\)-代数，和一个测度 \(\mu\)</li> </ul> <h3 id="推进测度">推进测度</h3> <p>假设有一个映射满足 \(T:\mathcal{X}\rightarrow \mathcal{Y}\)，那么\(\mu\) 通过 \(T\) 映射的推进测度（pushforward measure）满足 \begin{equation} T_{\# }\mu(\mathcal{Y})=\mu(T^{-1}(\mathcal{X})) \end{equation} 其中，因为 \(\mu\) 是测度，\(\mathcal{X},\mathcal{Y}\) 是数据集，所以二者计算的符号不同用以区别。这里的 \(T^{-1}(\mathcal{X})\) 表示集合 \(A\) 的原像，而不是将 \(T\) 的逆函数应用到 \(A\) 上。</p> <p>概率形式的边缘分布约束 \(\text{proj}_{ \# }^{x}\gamma = \mu\)，也就相当于上面提到的 \(\sum_{k} \Pi_{n k}=m_{n}\)。</p> <h3 id="传输方案">传输方案</h3> <p>假如 \(\gamma\) 有一个密度函数 \(p(x,y)\) 它的意思就是指把 \(x\) 上的土运到对应的 \(y\) 上形成一个分布，而不是某个单点。假如最优的传输方案如下图所示，右边就是 Monge problem 的解法，而 Kantorovich 的形式则约束更为宽松。</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/distribution-480.webp 480w,/assets/img/2020-01-30-optimal-transport/distribution-800.webp 800w,/assets/img/2020-01-30-optimal-transport/distribution-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/distribution.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="二维形式下可以表示成图中的内容" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">二维形式下可以表示成图中的内容</figcaption> </figure> </div> </div> <p>两个分布的联合分布如上图所示<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">3</a></sup>，同样的离散表示形式可以表示成下面的形式：</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2020-01-30-optimal-transport/discrete_distribution-480.webp 480w,/assets/img/2020-01-30-optimal-transport/discrete_distribution-800.webp 800w,/assets/img/2020-01-30-optimal-transport/discrete_distribution-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2020-01-30-optimal-transport/discrete_distribution.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="离散二维形式下可以表示成图中的内容" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">离散二维形式下可以表示成图中的内容</figcaption> </figure> </div> </div> <p>更一般的传输方案优化目标可以写成下面的形式： \begin{equation} C(\mu, \upsilon):=\min_{\gamma\in \Pi(\mu, \upsilon)}\int_{\mathcal{X}\times\mathcal{Y}}c(x,y)d\gamma(x, y) \end{equation}</p> <h2 id="最优传输散度">最优传输散度</h2> <p>在很多应用场景中，我们更加关心两个分布之间的距离而不是要把一个分布转化到另一个分布的传输方案。所以用最优传输的代价来表示这两个分布之间的差异下界。</p> <p>假如输入是两个分布 \(\mu\) 和 \(\upsilon\)，我们有两个分布之间的最优传输代价为： \begin{equation} \text{OT}_{c}[\mu, \upsilon] = \int_{\mathcal{X}\times\mathcal{Y}}c(x,y)d\gamma(x, y), \end{equation} 其中的代价函数 \(c(x,y)\) 可以有很多种选择：</p> <ul> <li> \[\| x-y\| _{1}\] </li> <li> \[\| x-y\| _{2}\] </li> <li> \[\| x-y\| _{2}^{2}\] </li> </ul> <p>如果将 \(\| x-y\| _{2}^{2}\) 代入则有 Wasserstein 距离为：</p> <p>\begin{equation} W_{2}[\mu,\upsilon]=\inf_{\gamma}\int |x-y|_{2}^{2}d\gamma(x,y) \end{equation}</p> <p>对于两个分布（概率测度）\(\mu\in\mathcal{P}(\mathcal{X}),\upsilon\in\mathcal{P}(\mathcal{Y})\)，他们之间的最优传输代价总和即为 \(C(\mu,\upsilon)\)，但是原始问题不太好求解，因为有时候可能根本没有解法，所以采取对偶问题来进行求解：</p> \[\begin{aligned} \min_{\gamma\in \Pi(\mu, \upsilon)} &amp; \int_{\mathcal{X}\times\mathcal{Y}}c(x,y)d\gamma(x, y)\quad &amp; (\text{Primal}) \\\\ \max_{\phi\in L^{1}(\mu)\\\\\psi \in L^{1}(\upsilon)} &amp; \{\int_{\mathcal{X}}\phi(x)d\mu(x)+\int_{\mathcal{Y}}\psi(y)d\upsilon(y):\phi(x)+\psi(y) \leq c(x,y)\}\quad &amp; (Dual) \end{aligned}\] <p>其中既要满足边缘分布的约束，也要保证两个相同分布之间的散度为零。\(\phi,\psi\) 分别表示两个分布的移动策略，这个策略能够使它们相互靠近。</p> <p>当最优条件满足的时候下面成立：</p> <ul> <li>对于 \(\gamma\) 而言，\(\phi(x)+\psi(y)=c(x,y)\) 几乎在每一个 \((x,y)\) 位置上都成立</li> <li>\(\gamma\) 集中在一个 c-周期性单调集上。</li> </ul> <p>最优传输是线性规划的问题的一个特例，因为要优化的函数和约束都是传输图的线性函数。线性规划的一个基本结果就是所有的线性问题都存在对偶问题。</p> <h2 id="参考">参考</h2> <p>关于对偶问题在离散化最优传输及线性规划中的解释可以进一步看<em>从Wasserstein距离、对偶理论到WGAN</em><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">4</a></sup></p> <hr> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p><a href="https://www.jiqizhixin.com/articles/2018-10-04-3" rel="external nofollow noopener" target="_blank">https://www.jiqizhixin.com/articles/2018-10-04-3</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:4" role="doc-endnote"> <p>M. Cuturi, “Sinkhorn Distances: Lightspeed Computation of Optimal Transport,” Advances in Neural Information Processing Systems, vol. 26, 2013, Accessed: Mar. 04, 2021. [Online]. Available: https://papers.nips.cc/paper/2013/hash/af21d0c97db2e27e13572cbf59eb343d-Abstract.html. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2" role="doc-endnote"> <p><em>Tutorial on Optimal Transport Theory</em> L´ena¨ıc Chizat <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:3" role="doc-endnote"> <p><a href="https://kexue.fm/archives/6280#%E7%BA%BF%E6%80%A7%E8%A7%84%E5%88%92%E4%B8%8E%E5%AF%B9%E5%81%B6" rel="external nofollow noopener" target="_blank">https://kexue.fm/archives/6280#%E7%BA%BF%E6%80%A7%E8%A7%84%E5%88%92%E4%B8%8E%E5%AF%B9%E5%81%B6</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/Word-Tricks/">Word 排版技巧</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/Black-First-Won/">Black First Won</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/Poincare-Ball-Model/">庞加莱球模型</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Introduction-to-LLMs/">Introduction to LLMs</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2015/images/">a post with images</a> </li> <div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"lccurious/lccurious.github.io","data-repo-id":"","data-category":"Comments","data-category-id":"","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Zenan Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>